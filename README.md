[Subsquid](https://www.subsquid.io/) is used to index and provide a graphql interface on top of Zeitgeist.
Types are defined  in  `schema.graphql` file.


## Zeitgeist's Self-Hosted Squids

* Dev Processor: https://processor.zeitgeist.pm/graphql
* Testnet Processor: https://processor.bsr.zeitgeist.pm/graphql
* Mainnet Processor: https://processor.rpc-0.zeitgeist.pm/graphql


## Concept

The substrate events are processed in a multi-step pipeline:

    Zeitgeist Chain => Subsquid Archive => Archive GraphQL Gateway => Subsquid Processor => Query Node API


## Prerequisites

* Node 16.x
* Docker

## Scripts

```bash
# The dependencies setup
yarn install --frozen-lockfile

# Run fresh development Zeitgeist PM node (accessible from
# ws://localhost:9944) from docker image and start all subsquid resources
For Mac users: yarn squid:mac:start
For Non-mac users: yarn squid:start

# Stop local subsquid docker resources
yarn squid:stop

# Commands to run testnet processor locally without docker

# Start processor db and redis cache db
yarn db:up

# Compile processor code
yarn build

# Processor's database operations

# Removes all existing migrations under `db/migrations` folde
rm -r db/migrations

# Creates initial migration
yarn migration:create

# Drop database
yarn db:down

# Run existing migrations onto database
yarn migration:apply

# Now you can start processing test chain data
REDIS_HOST=localhost DB_HOST=localhost NODE_ENV=test node lib/processor.js

# Open a separate terminal and launch the graphql server to query the processed data
yarn api:start

# Stop query-node
yarn api:stop
```


## Project Structure

Subsquid tools expect a certain directory layout:

* `src/generated` - model/server definitions created by `codegen`. Do not alter the contents of this directory manually.
* `src/server-extension` - module with custom `type-graphql` based resolvers
* `src/types` - data type definitions for chain events and extrinsics created by `typegen`.
* `src/mappings` - mapping module.
* `lib` - compiled js files. The structure of this directory must reflect `src`.

If you do not plan to extend GraphQl server you can delete `server-extension` module and then remove 
`type-graphql` and `class-validator` dependencies.


## Development Flow

### 1. Define database schema

Start development by defining the schema of the target database via `schema.graphql`.
Schema definition consists of regular graphql type declarations annotated with custom directives.
Full description of `schema.graphql` dialect is available [here](https://docs.subsquid.io/schema-file/).

### 2. Generate TypeORM classes

Mapping developers use [TypeORM](https://typeorm.io) entities
to interact with the target database during data processing. All necessary entity classes are
generated by the squid framework from `schema.graphql`. This is done by running `yarn codegen`
command.

### 3. Generate database migration

All database changes are applied through migration files located at `db/migrations`.
`squid-typeorm-migration` tool provides several commands to drive the process.
It is all [TypeORM](https://typeorm.io/#/migrations) under the hood.

```bash
# Connect to database, analyze its state and generate migration to match the target schema.
# The target schema is derived from entity classes generated earlier.
# Don't forget to run `yarn build` beforehand!
yarn migration:generate

# Apply database migrations from `db/migrations`
yarn migration:apply

# Revert the last performed migration
yarn migration:revert         
```